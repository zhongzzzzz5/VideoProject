<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="../../../layui/css/layui.css" media="all" />
    <link rel="stylesheet" href="../../../css/public.css" media="all" />
    <link rel="stylesheet" href="http://at.alicdn.com/t/font_2289172_hj8hlv6el5.css">
</head>
<body class="childrenBody">
<from class="layui-form">
    <div class="layui-block" style="padding-bottom: 10px">
        <a class="layui-btn layui-btn-sm layui-btn-primary" id="flush"><i class="layui-icon">&#xe666;</i>刷新</a>
        <a class="layui-btn layui-btn-sm layui-btn-primary" id="delete"><i class="layui-icon">&#xe640;</i>删除</a>
        <span style="float: right;margin-right: 20px;font-size: 25px;color: #c2c2c2"><i class="iconfont icon-shoujianxiang" style="font-size: 29px"></i> 收件箱</span>
    </div>
    <table id="inbox" lay-filter="inbox"></table>
    <script type="text/html" id="inboxBar">
        <button class="layui-btn layui-btn-xs" lay-event="read" style="margin-top: 3px">查看</button>
    </script>
</from>

    <script type="text/javascript" src="../../../common_config/common.js"></script>
    <script type="text/javascript" src="../../../layui/layui.js"></script>
    <script>
        layui.use(['form','upload','jquery','layer','table'],function () {
            var form = layui.form,
                upload = layui.upload,
                $ = layui.jquery,
                table = layui.table ,
                layer = parent.layer === undefined ? layui.layer : top.layer;

            /**
             *  收件箱*********************************开始
             */
            var inboxTableIns = table.render({
                elem: '#inbox',
                url : host_url+"index.php/Admin/MessageEmail/showInbox?id="+window.sessionStorage.getItem("UID"),
                page:true,
                id:"inboxTable",
                async: false,
                height : "full-40",
                cols : [[
                    {type: "checkbox", fixed:"left", width:50},
                    {field: 'id', title: '序号', width:60, align:"center"},
                    {field: 'from_username', title: '发件人',align:'center'},
                    {field: 'subject', title: '主题', align:'center'},
                    {field: 'file_name', title: '附件',  align:'center',templet:function (d) {
                            return d.file_name?d.file_name:"<span style='color:#cccccc;'>无</span>";
                        }},
                    {field: 'content', title: '内容', align:'center',templet:function (d) {
                            return d.content.substring(0,10);
                        }},
                    {field: 'add_time', title: '发送时间', align:'center'},
                    {field: 'is_read', title: '状态', align:'center',templet:function (d) {
                            return d.is_read == 0?"<span>未读</span>":"<span style='color:#cccccc;'>已读</span>"
                        }},
                    {title: '操作', minWidth:30, templet:'#inboxBar',fixed:"right",align:"center",width: 100}
                ]]
            });

            table.on('tool(inbox)',function (obj) {
                var layEvent = obj.event,
                    data = obj.data;
                if(layEvent === 'read'){
                    console.log(data);
                    layer.open({
                        type: 2,
                        title: data.subject,
                        shadeClose: true,
                        shade: 0.5,
                        area: ['380px', '90%'],
                        content: 'mobile/' //iframe的url
                    });
                }
            });

            //刷新按钮
            $("#flush").click(function () {
                let index = layui.layer.load(2, {shade: false}); //0代表加载的风格，支持0-2
                setTimeout(()=>{
                    inboxTableIns.reload();
                    layui.layer.close(index);
                },500)
            });

            //删除按钮
            $("#delete").click(function () {
                var checkStatus = table.checkStatus('inboxTable'),
                    data = checkStatus.data, ids = [];
                if(data.length > 0) {
                    for (var i in data) {
                        ids.push(data[i].id);
                    }
                    $.post(host_url+"index.php/Admin/MessageEmail/deleteEmail",
                        {
                            "ids" : ids
                        },
                        function (json) {

                        }
                    );
                }else {
                    layui.layer.msg("请选择需要删除的项",{icon:7});
                }
                console.log(ids)
            });

        })

    </script>
</body>
</html>